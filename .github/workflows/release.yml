name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build Release
      run: |
        # Set minimum macOS version for compatibility
        export MACOSX_DEPLOYMENT_TARGET=10.15
        
        # Clean previous builds
        swift package clean
        
        # Build Intel version for macOS 10.15 compatibility
        echo "ğŸ—ï¸ Building Intel (x86_64) version..."
        swift build -c release \
          --triple x86_64-apple-macos10.15 \
          -Xlinker -platform_version -Xlinker macos -Xlinker 10.15 -Xlinker 10.15
        
        # Immediately copy and rename Intel binary
        cp .build/release/CopyPathFinder .build/release/CopyPathFinder-x86_64
        
        # Create separate directory for ARM64 build
        mkdir -p .build-arm64/release
        swift build -c release \
          --triple arm64-apple-macos11.0 \
          -Xlinker -platform_version -Xlinker macos -Xlinker 11.0 -Xlinker 11.0 \
          --build-path .build-arm64
        
        # Copy ARM64 binary to standard location
        cp .build-arm64/release/CopyPathFinder .build/release/CopyPathFinder-arm64
        
        # Verify binary compatibility
        echo "ğŸ” Checking Intel binary compatibility:"
        otool -l .build/release/CopyPathFinder-x86_64 | grep -A5 "LC_VERSION_MIN_MACOSX" || echo "No LC_VERSION_MIN_MACOSX found"
        
        echo "ğŸ” Checking ARM64 binary compatibility:"
        otool -l .build/release/CopyPathFinder-arm64 | grep -A5 "LC_VERSION_MIN_MACOSX" || echo "No LC_VERSION_MIN_MACOSX found"
        
        # List available binaries
        echo "ğŸ“‹ Available binaries:"
        ls -la .build/release/
      
    - name: Package Application
      run: |
        # Create Intel version
        echo "ğŸ“¦ Packaging Intel version..."
        mkdir -p Release/Intel/CopyPathFinder.app/Contents/{MacOS,Resources}
        cp .build/release/CopyPathFinder-x86_64 Release/Intel/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        cp Sources/CopyPathFinder/Info.plist Release/Intel/CopyPathFinder.app/Contents/
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 10.15" Release/Intel/CopyPathFinder.app/Contents/Info.plist
        chmod +x Release/Intel/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        
        # Create ARM64 version
        echo "ğŸ“¦ Packaging ARM64 version..."
        mkdir -p Release/ARM64/CopyPathFinder.app/Contents/{MacOS,Resources}
        cp .build/release/CopyPathFinder-arm64 Release/ARM64/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        cp Sources/CopyPathFinder/Info.plist Release/ARM64/CopyPathFinder.app/Contents/
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 11.0" Release/ARM64/CopyPathFinder.app/Contents/Info.plist
        chmod +x Release/ARM64/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        
        # Add icons to both versions
        for arch in Intel ARM64; do
          if [ -f "Assets/AppIcon.icns" ]; then
            cp Assets/AppIcon.icns Release/$arch/CopyPathFinder.app/Contents/Resources/
          fi
          if [ -f "Assets/StatusIcon.png" ]; then
            cp Assets/StatusIcon.png Release/$arch/CopyPathFinder.app/Contents/Resources/
          fi
          if [ -f "Assets/StatusIcon@2x.png" ]; then
            cp Assets/StatusIcon@2x.png Release/$arch/CopyPathFinder.app/Contents/Resources/
          fi
        done
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply ad-hoc signatures to both versions
        echo "ğŸ” Signing Intel version..."
        codesign --force --deep --sign "-" --options runtime Release/Intel/CopyPathFinder.app
        codesign --verify --verbose Release/Intel/CopyPathFinder.app || true
        
        echo "ğŸ” Signing ARM64 version..."
        codesign --force --deep --sign "-" --options runtime Release/ARM64/CopyPathFinder.app
        codesign --verify --verbose Release/ARM64/CopyPathFinder.app || true
        
    - name: Code Sign (Optional - Developer Certificate)
      if: env.APPLE_SIGNING_IDENTITY != ''
      run: |
        echo "ğŸ›ï¸ Applying developer certificate signature..."
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/Intel/CopyPathFinder.app
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/ARM64/CopyPathFinder.app
      env:
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        
    - name: Create DMG
      run: |
        # Create DMG installers for both architectures
        chmod +x scripts/create-simple-dmg.sh
        
        echo "ğŸ“¦ Creating Intel DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/Intel/CopyPathFinder.app" "CopyPathFinder-Intel.dmg"
        
        echo "ğŸ“¦ Creating ARM64 DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/ARM64/CopyPathFinder.app" "CopyPathFinder-ARM64.dmg"
        
    - name: Create ZIP
      run: |
        # Create ZIP archives for both architectures
        cd Release/Intel
        zip -r ../../CopyPathFinder-Intel.zip CopyPathFinder.app
        cd ../ARM64
        zip -r ../../CopyPathFinder-ARM64.zip CopyPathFinder.app
        cd ../..
        
    - name: Generate Checksum
      run: |
        # Generate SHA256 checksums for all release files
        shasum -a 256 CopyPathFinder-Intel.dmg > CopyPathFinder-Intel.dmg.sha256
        shasum -a 256 CopyPathFinder-ARM64.dmg > CopyPathFinder-ARM64.dmg.sha256
        shasum -a 256 CopyPathFinder-Intel.zip > CopyPathFinder-Intel.zip.sha256
        shasum -a 256 CopyPathFinder-ARM64.zip > CopyPathFinder-ARM64.zip.sha256
        
    - name: Generate Release Notes
      run: |
        cat > release_notes.md << 'EOF'
        # ğŸš€ Copy Path Finder ${{ github.ref_name }}
        
        ## ğŸ—ï¸ æ¶æ„æ”¯æŒè¯´æ˜
        
        æœ¬ç‰ˆæœ¬æ”¯æŒå¤šæ¶æ„ï¼Œè¯·æ ¹æ®ä½ çš„ Mac èŠ¯ç‰‡é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š
        
        | æ¶æ„ç‰ˆæœ¬ | æ”¯æŒç³»ç»Ÿ | é€‚ç”¨è®¾å¤‡ | ä¸‹è½½æ–‡ä»¶ |
        |---------|---------|---------|---------|
        **Intel (x86_64)** | macOS 10.15+ | Intel èŠ¯ç‰‡ Mac | `CopyPathFinder-Intel.dmg/zip` |
        **Apple Silicon (ARM64)** | macOS 11.0+ | M123 èŠ¯ç‰‡ Mac | `CopyPathFinder-ARM64.dmg/zip` |
        
        ### ğŸ”§ å®‰è£…æ–¹æ³•
        
        1. **DMG å®‰è£…åŒ…** (æ¨è)
           - æ ¹æ®èŠ¯ç‰‡é€‰æ‹©å¯¹åº”ç‰ˆæœ¬ï¼š`CopyPathFinder-Intel.dmg` æˆ– `CopyPathFinder-ARM64.dmg`
           - åŒå‡»æŒ‚è½½ï¼Œæ‹–æ‹½åº”ç”¨åˆ° Applications æ–‡ä»¶å¤¹
           - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸è¿è¡Œ
        
        2. **ZIP å‹ç¼©åŒ…**
           - æ ¹æ®èŠ¯ç‰‡é€‰æ‹©ï¼š`CopyPathFinder-Intel.zip` æˆ– `CopyPathFinder-ARM64.zip`
           - è§£å‹åå°† `CopyPathFinder.app` å¤åˆ¶åˆ° Applications æ–‡ä»¶å¤¹
        
        ### ğŸ” å®‰å…¨æç¤º
        
        æœ¬ç‰ˆæœ¬ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œé¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½çœ‹åˆ°å®‰å…¨æç¤ºï¼š
        
        **è§£å†³æ–¹æ³•ï¼š**
        - å³é”®ç‚¹å‡»åº”ç”¨ â†’ "æ‰“å¼€" â†’ åœ¨å¼¹å‡ºçš„è­¦å‘Šä¸­ç‚¹å‡»"æ‰“å¼€"
        - æˆ–åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§"ä¸­ç‚¹å‡»"ä»è¦æ‰“å¼€"
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        
        - ğŸ“‹ ä¸€é”®å¤åˆ¶æ–‡ä»¶è·¯å¾„
        - ğŸ¯ æ”¯æŒ Finder å’Œè®¿è¾¾
        - ğŸ ä¸“ä¸º macOS è®¾è®¡
        - ğŸ“± çŠ¶æ€æ å›¾æ ‡ï¼Œéšæ—¶å¯ç”¨
        - ğŸŒ æ”¯æŒä¸­è‹±æ–‡ç•Œé¢
        
        ### ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
        
        - **Intel ç‰ˆæœ¬**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
        - **ARM64 ç‰ˆæœ¬**: macOS 11.0 (Big Sur) æˆ–æ›´é«˜ç‰ˆæœ¬
        - éœ€è¦æˆäºˆ Apple Events æƒé™
        
        ### ğŸ“ ä½¿ç”¨æ–¹æ³•
        
        1. å¯åŠ¨åº”ç”¨åï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤ºå›¾æ ‡
        2. åœ¨ Finder ä¸­é€‰ä¸­æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        3. ç‚¹å‡»çŠ¶æ€æ å›¾æ ‡æˆ–ä½¿ç”¨å¿«æ·é”®
        4. æ–‡ä»¶è·¯å¾„å°†è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
        
        ### ğŸ”— ç›¸å…³é“¾æ¥
        
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/tekintian/CopyPathFinder/blob/main/README.md)
        - [è‡ªç­¾åæŒ‡å—](https://github.com/tekintian/CopyPathFinder/blob/main/docs/SELF_SIGNING.md)
        - [é—®é¢˜åé¦ˆ](https://github.com/tekintian/CopyPathFinder/issues)
        
        ---
        
        **ğŸ“Š æ–‡ä»¶æ ¡éªŒ**
        - SHA256 æ ¡éªŒå’Œæ–‡ä»¶å·²æä¾›ï¼Œè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        - `shasum -a 256 -c CopyPathFinder-Intel.dmg.sha256` (Intel ç‰ˆæœ¬)
        - `shasum -a 256 -c CopyPathFinder-ARM64.dmg.sha256` (ARM64 ç‰ˆæœ¬)
        
        **âš ï¸ å…è´£å£°æ˜**
        æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œä½¿ç”¨é£é™©è‡ªè´Ÿã€‚
        EOF
        
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          CopyPathFinder-Intel.dmg
          CopyPathFinder-Intel.dmg.sha256
          CopyPathFinder-ARM64.dmg
          CopyPathFinder-ARM64.dmg.sha256
          CopyPathFinder-Intel.zip
          CopyPathFinder-Intel.zip.sha256
          CopyPathFinder-ARM64.zip
          CopyPathFinder-ARM64.zip.sha256
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}