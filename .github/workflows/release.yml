name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: macos-12
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v3
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build Release
      run: swift build -c release
      
    - name: Package Application
      run: |
        # Create app bundle
        mkdir -p Release/CopyPathFinder.app/Contents/{MacOS,Resources}
        cp .build/release/CopyPathFinder Release/CopyPathFinder.app/Contents/MacOS/
        cp Sources/CopyPathFinder/Info.plist Release/CopyPathFinder.app/Contents/
        
        # Set executable permissions
        chmod +x Release/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        
        # Add app icon if available
        if [ -f "Assets/AppIcon.icns" ]; then
          cp Assets/AppIcon.icns Release/CopyPathFinder.app/Contents/Resources/
        fi
        
        # Add status bar icons if available
        if [ -f "Assets/StatusIcon.png" ]; then
          cp Assets/StatusIcon.png Release/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon@2x.png" ]; then
          cp Assets/StatusIcon@2x.png Release/CopyPathFinder.app/Contents/Resources/
        fi
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply simple ad-hoc signature
        echo "ğŸ” Applying ad-hoc signature..."
        codesign --force --deep --sign "-" Release/CopyPathFinder.app
        
        # Verify signature
        codesign --verify --verbose Release/CopyPathFinder.app || true
        
    - name: Code Sign (Optional - Developer Certificate)
      if: env.APPLE_SIGNING_IDENTITY != ''
      run: |
        echo "ğŸ›ï¸ Applying developer certificate signature..."
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/CopyPathFinder.app
      env:
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        
    - name: Create DMG
      run: |
        # Create DMG installer
        mkdir -p dmg_root/CopyPathFinder
        cp -R Release/CopyPathFinder.app dmg_root/CopyPathFinder/
        
        # Create DMG with custom icon layout
        hdiutil create -volname "Copy Path Finder" -srcfolder dmg_root -ov -format UDZO CopyPathFinder.dmg
        
    - name: Create ZIP
      run: |
        cd Release
        zip -r CopyPathFinder.zip CopyPathFinder.app
        
    - name: Generate Checksum
      run: |
        sha256sum CopyPathFinder.dmg > CopyPathFinder.dmg.sha256
        sha256sum Release/CopyPathFinder.zip > CopyPathFinder.zip.sha256
        
    - name: Generate Release Notes
      run: |
        cat > release_notes.md << 'EOF'
        # ğŸš€ Copy Path Finder ${{ github.ref_name }}
        
        ## ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        ### ğŸ”§ å®‰è£…æ–¹æ³•
        
        1. **DMG å®‰è£…åŒ…** (æ¨è)
           - ä¸‹è½½ `CopyPathFinder.dmg`
           - åŒå‡»æŒ‚è½½ï¼Œæ‹–æ‹½åº”ç”¨åˆ° Applications æ–‡ä»¶å¤¹
           - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸è¿è¡Œ
        
        2. **ZIP å‹ç¼©åŒ…**
           - ä¸‹è½½ `CopyPathFinder.zip`
           - è§£å‹åå°† `CopyPathFinder.app` å¤åˆ¶åˆ° Applications æ–‡ä»¶å¤¹
        
        ### ğŸ” å®‰å…¨æç¤º
        
        æœ¬ç‰ˆæœ¬ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œé¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½çœ‹åˆ°å®‰å…¨æç¤ºï¼š
        
        **è§£å†³æ–¹æ³•ï¼š**
        - å³é”®ç‚¹å‡»åº”ç”¨ â†’ "æ‰“å¼€" â†’ åœ¨å¼¹å‡ºçš„è­¦å‘Šä¸­ç‚¹å‡»"æ‰“å¼€"
        - æˆ–åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§"ä¸­ç‚¹å‡»"ä»è¦æ‰“å¼€"
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        
        - ğŸ“‹ ä¸€é”®å¤åˆ¶æ–‡ä»¶è·¯å¾„
        - ğŸ¯ æ”¯æŒ Finder å’Œè®¿è¾¾
        - ğŸ ä¸“ä¸º macOS è®¾è®¡
        - ğŸ“± çŠ¶æ€æ å›¾æ ‡ï¼Œéšæ—¶å¯ç”¨
        - ğŸŒ æ”¯æŒä¸­è‹±æ–‡ç•Œé¢
        
        ### ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
        
        - macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬
        - éœ€è¦æˆäºˆ Apple Events æƒé™
        
        ### ğŸ“ ä½¿ç”¨æ–¹æ³•
        
        1. å¯åŠ¨åº”ç”¨åï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤ºå›¾æ ‡
        2. åœ¨ Finder ä¸­é€‰ä¸­æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        3. ç‚¹å‡»çŠ¶æ€æ å›¾æ ‡æˆ–ä½¿ç”¨å¿«æ·é”®
        4. æ–‡ä»¶è·¯å¾„å°†è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
        
        ### ğŸ”— ç›¸å…³é“¾æ¥
        
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/tekintian/CopyPathFinder/blob/main/README.md)
        - [è‡ªç­¾åæŒ‡å—](https://github.com/tekintian/CopyPathFinder/blob/main/docs/SELF_SIGNING.md)
        - [é—®é¢˜åé¦ˆ](https://github.com/tekintian/CopyPathFinder/issues)
        
        ---
        
        **ğŸ“Š æ–‡ä»¶æ ¡éªŒ**
        - SHA256 æ ¡éªŒå’Œæ–‡ä»¶å·²æä¾›ï¼Œè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        - `sha256sum -c CopyPathFinder.dmg.sha256`
        
        **âš ï¸ å…è´£å£°æ˜**
        æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œä½¿ç”¨é£é™©è‡ªè´Ÿã€‚
        EOF
        
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          CopyPathFinder.dmg
          CopyPathFinder.dmg.sha256
          Release/CopyPathFinder.zip
          Release/CopyPathFinder.zip.sha256
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}