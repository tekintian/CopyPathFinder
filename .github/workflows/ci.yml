name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build
      run: |
        # Set minimum macOS version for compatibility
        export MACOSX_DEPLOYMENT_TARGET=10.15
        
        # Build universal binary for Intel and Apple Silicon with explicit target
        swift build -c release --triple x86_64-apple-macos10.15 --triple arm64-apple-macos10.15
      
    - name: Test
      run: |
        # Run basic syntax check
        swift build -c debug
        
    - name: Package Application
      run: |
        mkdir -p artifact
        cp -R .build/release/CopyPathFinder artifact/
        
        # Create app bundle
        mkdir -p artifact/CopyPathFinder.app/Contents/MacOS
        mkdir -p artifact/CopyPathFinder.app/Contents/Resources
        cp artifact/CopyPathFinder artifact/CopyPathFinder.app/Contents/MacOS/
        cp Sources/CopyPathFinder/Info.plist artifact/CopyPathFinder.app/Contents/
        
        # Verify Info.plist has correct minimum version
        echo "ðŸ” Checking minimum system version in Info.plist..."
        /usr/libexec/PlistBuddy -c "Print :LSMinimumSystemVersion" artifact/CopyPathFinder.app/Contents/Info.plist
        
        # Add app icon if available
        if [ -f "Assets/AppIcon.icns" ]; then
          cp Assets/AppIcon.icns artifact/CopyPathFinder.app/Contents/Resources/
        fi
        
        # Add status bar icons if available
        if [ -f "Assets/StatusIcon.png" ]; then
          cp Assets/StatusIcon.png artifact/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon@2x.png" ]; then
          cp Assets/StatusIcon@2x.png artifact/CopyPathFinder.app/Contents/Resources/
        fi
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply simple ad-hoc signature for CI builds
        echo "ðŸ” Applying ad-hoc signature..."
        codesign --force --deep --sign "-" --options runtime artifact/CopyPathFinder.app
        
        # Verify signature and check minimum version
        codesign --verify --verbose artifact/CopyPathFinder.app || true
        
        # Check if the binary is compatible with macOS 10.15
        echo "ðŸ” Checking binary compatibility..."
        otool -l artifact/CopyPathFinder.app/Contents/MacOS/CopyPathFinder | grep -A5 "LC_VERSION_MIN_MACOSX" || true
        
    - name: Create DMG
      run: |
        # Create simple DMG with drag-and-drop support
        echo "ðŸ“¦ Creating DMG installer..."
        chmod +x scripts/create-simple-dmg.sh
        ./scripts/create-simple-dmg.sh "artifact/CopyPathFinder.app" "artifact/CopyPathFinder.dmg"
        
        # Verify DMG was created
        echo "ðŸ” DMG file info:"
        ls -la artifact/CopyPathFinder.dmg
        hdiutil attach artifact/CopyPathFinder.dmg -readonly -mountpoint /tmp/dmg_test 2>/dev/null || true
        if [ -d "/tmp/dmg_test" ]; then
          echo "âœ… DMG mounted successfully"
          echo "ðŸ“ DMG contents:"
          ls -la /tmp/dmg_test/
          hdiutil detach /tmp/dmg_test 2>/dev/null || true
        fi
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CopyPathFinder-macOS
        path: artifact/
        retention-days: 30
        
  release:
    needs: build
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: CopyPathFinder-macOS
        path: artifact/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifact/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}