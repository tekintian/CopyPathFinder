name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build
      run: |
        # Set minimum macOS version for compatibility
        export MACOSX_DEPLOYMENT_TARGET=10.15
        
        # Clean previous builds
        swift package clean
        
        # Build Intel version for macOS 10.15 compatibility
        echo "ðŸ—ï¸ Building Intel (x86_64) version..."
        swift build -c release \
          --triple x86_64-apple-macos10.15 \
          -Xlinker -platform_version -Xlinker macos -Xlinker 10.15 -Xlinker 10.15
        
        # Copy Intel binary
        cp .build/release/CopyPathFinder .build/release/CopyPathFinder-x86_64
        
        # Clean and build ARM64 version
        swift package clean
        
        echo "ðŸ—ï¸ Building ARM64 version..."
        swift build -c release \
          --triple arm64-apple-macos11.0 \
          -Xlinker -platform_version -Xlinker macos -Xlinker 11.0 -Xlinker 11.0
        
        # Copy ARM64 binary
        cp .build/release/CopyPathFinder .build/release/CopyPathFinder-arm64
        
        # Verify binary compatibility
        echo "ðŸ” Checking Intel binary compatibility:"
        otool -l .build/release/CopyPathFinder-x86_64 | grep -A5 "LC_VERSION_MIN_MACOSX" || echo "No LC_VERSION_MIN_MACOSX found"
        
        echo "ðŸ” Checking ARM64 binary compatibility:"
        otool -l .build/release/CopyPathFinder-arm64 | grep -A5 "LC_VERSION_MIN_MACOSX" || echo "No LC_VERSION_MIN_MACOSX found"
      
    - name: Test
      run: |
        # Run basic syntax check
        swift build -c debug
        
    - name: Package Application
      run: |
        mkdir -p artifact
        
        # Create Intel version directory
        echo "ðŸ“¦ Packaging Intel version..."
        mkdir -p artifact/Intel/CopyPathFinder.app/Contents/MacOS
        mkdir -p artifact/Intel/CopyPathFinder.app/Contents/Resources
        cp .build/release/CopyPathFinder-x86_64 artifact/Intel/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        
        # Copy Info.plist and set minimum version for Intel
        cp Sources/CopyPathFinder/Info.plist artifact/Intel/CopyPathFinder.app/Contents/
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 10.15" artifact/Intel/CopyPathFinder.app/Contents/Info.plist
        
        # Add icons to Intel version
        if [ -f "Assets/AppIcon.icns" ]; then
          cp Assets/AppIcon.icns artifact/Intel/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon.png" ]; then
          cp Assets/StatusIcon.png artifact/Intel/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon@2x.png" ]; then
          cp Assets/StatusIcon@2x.png artifact/Intel/CopyPathFinder.app/Contents/Resources/
        fi
        
        # Create ARM64 version directory
        echo "ðŸ“¦ Packaging ARM64 version..."
        mkdir -p artifact/ARM64/CopyPathFinder.app/Contents/MacOS
        mkdir -p artifact/ARM64/CopyPathFinder.app/Contents/Resources
        cp .build/release/CopyPathFinder-arm64 artifact/ARM64/CopyPathFinder.app/Contents/MacOS/CopyPathFinder
        
        # Copy Info.plist and set minimum version for ARM64
        cp Sources/CopyPathFinder/Info.plist artifact/ARM64/CopyPathFinder.app/Contents/
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 11.0" artifact/ARM64/CopyPathFinder.app/Contents/Info.plist
        
        # Add icons to ARM64 version
        if [ -f "Assets/AppIcon.icns" ]; then
          cp Assets/AppIcon.icns artifact/ARM64/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon.png" ]; then
          cp Assets/StatusIcon.png artifact/ARM64/CopyPathFinder.app/Contents/Resources/
        fi
        if [ -f "Assets/StatusIcon@2x.png" ]; then
          cp Assets/StatusIcon@2x.png artifact/ARM64/CopyPathFinder.app/Contents/Resources/
        fi
        
        # Verify Info.plist versions
        echo "ðŸ” Intel version requires macOS $(/usr/libexec/PlistBuddy -c "Print :LSMinimumSystemVersion" artifact/Intel/CopyPathFinder.app/Contents/Info.plist)"
        echo "ðŸ” ARM64 version requires macOS $(/usr/libexec/PlistBuddy -c "Print :LSMinimumSystemVersion" artifact/ARM64/CopyPathFinder.app/Contents/Info.plist)"
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply ad-hoc signatures to both versions
        echo "ðŸ” Signing Intel version..."
        codesign --force --deep --sign "-" --options runtime artifact/Intel/CopyPathFinder.app
        codesign --verify --verbose artifact/Intel/CopyPathFinder.app || true
        
        echo "ðŸ” Signing ARM64 version..."
        codesign --force --deep --sign "-" --options runtime artifact/ARM64/CopyPathFinder.app
        codesign --verify --verbose artifact/ARM64/CopyPathFinder.app || true
        
        # Check binary compatibility
        echo "ðŸ” Checking Intel binary compatibility:"
        otool -l artifact/Intel/CopyPathFinder.app/Contents/MacOS/CopyPathFinder | grep -A5 "LC_VERSION_MIN_MACOSX" || true
        
        echo "ðŸ” Checking ARM64 binary compatibility:"
        otool -l artifact/ARM64/CopyPathFinder.app/Contents/MacOS/CopyPathFinder | grep -A5 "LC_VERSION_MIN_MACOSX" || true
        
    - name: Create DMG
      run: |
        # Create DMG installers for both architectures
        chmod +x scripts/create-simple-dmg.sh
        
        echo "ðŸ“¦ Creating Intel DMG installer..."
        ./scripts/create-simple-dmg.sh "artifact/Intel/CopyPathFinder.app" "artifact/CopyPathFinder-Intel.dmg"
        
        echo "ðŸ“¦ Creating ARM64 DMG installer..."
        ./scripts/create-simple-dmg.sh "artifact/ARM64/CopyPathFinder.app" "artifact/CopyPathFinder-ARM64.dmg"
        
        # Verify DMGs were created
        echo "ðŸ” DMG files info:"
        ls -la artifact/*.dmg
        
        # Verify Intel DMG contents
        hdiutil attach artifact/CopyPathFinder-Intel.dmg -readonly 2>/dev/null || true
        if [ -d "/Volumes/Copy Path Finder" ]; then
          echo "âœ… Intel DMG mounted successfully"
          echo "ðŸ“ Intel DMG contents:"
          ls -la "/Volumes/Copy Path Finder/"
          hdiutil detach "/Volumes/Copy Path Finder" 2>/dev/null || true
        fi
        
        # Verify ARM64 DMG contents
        hdiutil attach artifact/CopyPathFinder-ARM64.dmg -readonly 2>/dev/null || true
        if [ -d "/Volumes/Copy Path Finder" ]; then
          echo "âœ… ARM64 DMG mounted successfully"
          echo "ðŸ“ ARM64 DMG contents:"
          ls -la "/Volumes/Copy Path Finder/"
          hdiutil detach "/Volumes/Copy Path Finder" 2>/dev/null || true
        fi
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CopyPathFinder-macOS
        path: |
          artifact/*.dmg
          artifact/Intel/
          artifact/ARM64/
        retention-days: 30
        
  release:
    needs: build
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: CopyPathFinder-macOS
        path: artifact/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifact/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}